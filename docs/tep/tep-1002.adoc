= TEP-1002: Git backend

Add git as backend for transaction data store.


== Journal file format

No changes needed to directly to support this feature,
but from reporting perspective some changes are useful later on.

=== Equity report

Record with Equity txn commit id of used revision.

This probably needs parser level changes to format 
to support `meta: commit` or similar.


== Machinery

Changes to machinery

* [x] git backend
** [ ] high level Tackler specific java interface?
* [x] bifurcation point for Filesyste (FS) and GIT backend and data feeding for parser
** [x] way to re-feed git streams to ANTLR lexer streams?


=== New dependecies

* [x] link:http://www.eclipse.org/jgit/[jgit]
** [x] Add and check licenses: link:http://git.eclipse.org/c/jgit/jgit.git/plain/LICENSE[EDL]
** [x] Is there NOTICE files? No
** [x] Add license under link:../licenses[doc/licenses]
** [x] Add link of license to link:../index.adoc[index]
** [x] Add link:../../THANKS.adoc[THANKS]

=== Examples

* [x] link:https://github.com/centic9/jgit-cookbook[jgit-cookbook]
** [x] Add and check licenses: link:https://github.com/centic9/jgit-cookbook/blob/master/LICENSE.md[Apache License 2.0]
** [x] Is there NOTICE files? No
** [x] Add license under link:../licenses[doc/licenses]
** [x] Add link of license to link:../index.adoc[index]
** [x] Add link:../../THANKS.adoc[THANKS]


=== Phase-2

* [ ] Integration with link:https://github.com/gitblit/gitblit[Gitblit]?
** [ ] License: link:https://github.com/gitblit/gitblit/blob/master/LICENSE[Apache License 2.0]
*** [ ] link:https://github.com/gitblit/gitblit/blob/master/NOTICE[NOTICE]


=== CLI changes

Changes to command line interface

* [x] git:
** [x] set branch/ref
*** [x] single file as git input (inside repo) is not supported (workaround path+suffix)
** [x] set commit


=== CONF changes

Changes to conf-settings

* [x] input: set backend type (FS or GIT)
* [x] git-specific conf-settings
** [x] set default branch/refs to be used
*** [x] (fixed commit is not supported by conf)
** [x] git input data
*** [x] set path inside repo
*** [x] set glob / suffix

== Reporting

Changes to general reporting

* [ ] Reports should produce meta information about txns and report
** [ ] human readable output (text-format)
** [ ] machine readable: JSON?

* [ ] Git backend specific information
** [ ] commit


=== Balance report

Changes to balance report

* [ ] Output meta-info
** [ ] Git backend: commit


=== Balance Group report

Changes to balance group report

* [ ] Output meta-info
** [ ] Git backend: commit


=== Register report

Changes to register report

* [ ] Output meta-info
** [ ] Git backend: commit


=== Equity report

Changes to equity report. See Journal changes.

* [ ] record used tree (commit id)


=== Identity report

None at the moment (journal sidecar file?)

== Documentation

* [ ] CHANGELOG item
* [ ] User docs
** [ ] user manual
*** [ ] abbreviated sha1 is not supported
*** [ ] cli-arguments
**** [ ] `--input.git.ref`
**** [ ] `--input.git.commit`
** [ ] tackler.conf
** [ ] accounts.conf
** [ ] examples
* [ ] Developer docs


== Tests

* [x] UTF-8 data from git backend
* [x] data shard
** [x] shard: check effective dir
** [x] shard: check not-to-included case
*** [x] not by dir
*** [x] not by suffix
* [x] conf-settings
** [x] `--input.git.repository`
** [x] `--input.git.ref`
** [x] `--input.git.dir`
** [x] `--input.git.suffix`
* [x] cli-arguments
** [x] `--input.git.ref`
** [x] `--input.git.commit`
*** [x] effective commit id (e.g. not latest commit)

=== Errors

* [x] e: unknown storage type
* [x] e: repository not found
* [x] e: simple parse error with shard
* [x] e: commit
** [x] e: commit not found
** [x] e: format of commit is not valid
** [ ] e: abbreviated sha1
* [x] e: ref
** [x] e: ref not found
** [x] e: format of ref is not valid?
* [ ] e: path not found
* [ ] e: empty txns set with commit + path
* [ ] e: non-bare git directory
* [x] e: txns/foo.txn as directory
* [x] e: txns/foo.txn as link
* [ ] e: cli: conflicting options
** [ ] e: git with non-git storage
** [x] e: cli: --input.git.commit + --input.git.ref
** [x] e: cli: --input.file + --input.git.ref
** [x] e: cli: --input.file + --input.git.commit
** [x] e: cli: --input.txn.dir + --input.git.ref
** [x] e: cli: --input.txn.dir + --input.git.commit
** [x] e: cli: --input.txn.glob + --input.git.ref
** [x] e: cli: --input.txn.glob + --input.git.commit

=== Perf

* [ ] git backend perf tests
** [ ] shard data

=== Metadata for test coverage tracking

....
features:
  - feature:
      id: 06b4a9b1-f48c-4b33-8811-1f32cdc44d7b
      subject: "git backend"

  - feature:
      id: uuid
      parent: uuid
      subject: "one-line description"
....

basic:
# test:uuid: 292f250d-7cb2-4114-92e1-10f9a8d5b381

shard + cli ref arg
# test:uuid: 1d2c22c1-e3fa-4cd4-a526-45318c15d13e

# commit id 1st
# test:uuid: ede5d6b5-1885-4e02-8f9d-e2e1034fb6e3

# commit-id 2nd
# test:uuid: 7dfebf19-480c-4bf5-806a-4d560a20a1d4

# commit-id 3rd
# test:uuid: f44faf05-7019-4c34-b0af-3345feb4ad37

# utf8 data
# test:uuid: c2f39ef7-c085-4ff4-af4d-85a50d0ee203

# parser error with shard data
# test:uuid: 25452d77-aae5-414c-a6a6-bd60f090731e

# malformed sha1 (valid but truncated)
# test:uuid: aeb11f77-ba35-400f-bdae-50d6ebb7e098

# commit not found
# test:uuid: c233295d-08b9-49b5-b384-634fc8432e64
